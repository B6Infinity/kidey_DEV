{% extends 'staff/base.html' %}
{% block title %}Orders{% endblock title %}
{% block body %}





<div class="flex-row row-responsive" style="width: 100%; height: 100%;">

    <div class="flex-object" id="addproduct_container" style="flex-grow: 1;">
        <div id="addaproduct" class="fnt-med">Create Order Instance</div>

        <div id="add-product-container">

            <script>let orderJson = {}; let totalBill = 0; let discount = 0;</script>

            <form action="/staff/add-product" method="POST">
                {% csrf_token %}

                <div class="flex-row row-responsive">

                    <div class="flex-object">

                        <input class="input-classic" name="customer_name" type="text"
                            onchange="fetchCustomer(this.value, 'name')" placeholder="Customer Name" autocomplete="off"
                            required>
                        <input class="input-classic" name="customer_phone_no" type="number"
                            onchange="fetchCustomer(this.value, 'phone_no')" placeholder="Customer Phone"
                            autocomplete="off" required maxlength="10">

                        <br>Time Of Order:
                        <input class="input-classic" name="time_of_order" type="datetime-local"
                            placeholder="Time Of Order" autocomplete="off" required>
                        <br>Time Of Delivery:
                        <input class="input-classic" name="time_of_delivery" type="datetime-local"
                            placeholder="Time Of Delivery" autocomplete="off" required><br>
                        <br>
                        <input class="input-classic" style="width: 100px; background-color: #101010;" name="total_bill"
                            type="number" placeholder="Total Bill" autocomplete="off" disabled>-
                        <input class="input-classic" style="width: 100px;" onchange="addDiscount(Number(this.value));"
                            name="discount" type="number" placeholder="Discount" autocomplete="off">
                        <input class="input-classic" style="width: 90px; background-color: #101010;" name="payable_amt"
                            type="number" placeholder="Payable ₹" autocomplete="off" disabled>

                    </div>



                    <!-- PRODUCT LIST -->

                    <div class="flex-object" style="width: 200px;">
                        <div class="fnt-med">Product List</div>

                        <div id="product_list">
                            <script>let products = {};</script>
                            {% for product in EXISTING_PRODUCTS %}
                            <div id="product-{{product.id}}" class="product_list-product">

                                {{product.name}} <br>

                                <span style=" font-weight: 800;">₹{{product.price}}/-</span>
                                <div class="productcounter-container">
                                    <span onclick="countProduct('{{product.id}}', 'add')" class="add-product">+</span>
                                    <span id="product-counter-{{product.id}}" class="counter-product">0</span>
                                    <span onclick="countProduct('{{product.id}}', 'substract')"
                                        class="add-product">-</span>
                                </div>

                            </div>

                            <script>products["{{product.id}}"] = {{ product.price }};</script>

                            {% endfor %}

                        </div>

                    </div>

                    <script>

                        function countProduct(product_id, operation) {
                            let count = Number(document.getElementById('product-counter-' + product_id).textContent);
                            if (operation == 'add') count++;
                            else { if (count != 0) count--; }

                            document.getElementById('product-counter-' + product_id).textContent = count;

                            // CHANGE CSS
                            if (count == 0) {
                                document.getElementById('product-' + product_id).classList.remove('non-zero-product');
                            } else document.getElementById('product-' + product_id).classList.add('non-zero-product');

                            if (count == 0) delete orderJson[product_id]; else orderJson[product_id] = count;

                            evaluateBill();




                        }

                        function evaluateBill() {
                            totalBill = 0;
                            for (let product in orderJson) {
                                let money = products[product] * orderJson[product];
                                totalBill += money;
                                // console.log(totalBill);
                            }

                            if (Object.keys(orderJson).length == 0) totalBill = 0;


                            // CHANGE HTML
                            document.getElementsByName('total_bill')[0].value = totalBill;
                            document.getElementsByName('payable_amt')[0].value = totalBill - discount;
                        }

                        function addDiscount(d) {
                            discount = d; evaluateBill();
                        }

                        let csrftoken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
                        function fetchCustomer(data, datatype) {
                            // console.log(data, datatype);

                            let form = new FormData();
                            form.set('data', data);
                            form.set('datatype', datatype);

                            fetch(`fetchCustomer`,
                                {
                                    method: 'POST',
                                    body: form,
                                    headers: {
                                        'Accept': 'multipart/form-data, application/json, text/plain, */*',
                                        "X-CSRFToken": csrftoken
                                    },
                                })
                                .then(response => response.json())
                                .then(data => {

                                    if (data["ERROR"] == null){
                                        // CHANGE HTML
                                        document.getElementsByName('customer_name')[0].value = data["MATCHING_CUSTOMER"]["Name"];
                                        document.getElementsByName('customer_phone_no')[0].value = data["MATCHING_CUSTOMER"]["Phone"];
                                    }
                                });

                        }

                    </script>

                </div>


                <br><br>
                <button class="big-button" id="createbutton" type="button" style="font-size: 18px;">Create</button>


            </form>

        </div>

    </div>
    <hr>

    <!-- EXISTING PRODUCTS -->

    <div class="flex-object" id="exisitingproductsflexbox">
        <div class="fnt-med">Existing Orders</div>

        <br>

        <div id="existing-products-container" style="height: 90%; overflow-y:auto;">

            {% for order in EXISTING_ORDERS %}
            <div class="existing-product">
                <div style="display: flex;">
                    <div id="{{product.id}}-name" class="fnt-x-small" style="flex-grow: 1;">{{order.customer}}
                    </div>


                    <div class="edit-button" onclick="">Edit</div>
                </div>
                <div style="display: flex; margin: 2px; padding: 5px; padding-bottom:0;">
                    <div id="{{product.id}}-price" style="flex-grow: 1;">₹{{order.payable_amt}}</div>

                </div>
            </div>
            {% endfor %}

        </div>



    </div>



</div>









<script>
    if ("{{CURRENT_PAGE}}" == "orders") {
        document.getElementById('{{CURRENT_PAGE}}-hotbar').classList.add('hotbar-active');
    }

</script>
{% endblock body %}